version: '3.8'

services:
  model-downloader:
    image: python:3.10-slim
    container_name: tts-model-downloader
    volumes:
      - tts-checkpoints:/data/checkpoints
    command: >
      bash -c "pip install --upgrade pip &&
      pip install 'huggingface_hub>=0.23.0' && 
      python3 -c \"from huggingface_hub import snapshot_download; snapshot_download(repo_id='fishaudio/openaudio-s1-mini', local_dir='/data/checkpoints/openaudio-s1-mini')\""

  fish-speech:
    image: fishaudio/fish-speech:latest-dev
    container_name: fish-speech
    ports:
      - "7860:7860" # WebUI
      - "8081:8080" # API (Mapped to 8081 to avoid conflict)
    volumes:
      - tts-checkpoints:/app/checkpoints
      - ./references:/app/references
    environment:
      - GRADIO_SERVER_NAME=0.0.0.0
      - API_SERVER_NAME=0.0.0.0
      - BACKEND=cpu # Fallback to CPU since no GPU is available
      - LLAMA_CHECKPOINT_PATH=checkpoints/openaudio-s1-mini
      - DECODER_CHECKPOINT_PATH=checkpoints/openaudio-s1-mini
    restart: unless-stopped
    depends_on:
      model-downloader:
        condition: service_completed_successfully

volumes:
  tts-checkpoints:
